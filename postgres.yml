# syntax=docker/dockerfile:1
FROM ubuntu:20.04

ARG DEBIAN_FRONTEND=noninteractive
ARG POSTGRES_VERSION
ARG POSTGRES_USER
ARG POSTGRES_PASSWORD

ENV POSTGRES_VERSION $POSTGRES_VERSION
ENV POSTGRES_USER $POSTGRES_USER
ENV POSTGRES_PASSWORD $POSTGRES_PASSWORD

RUN apt-get update && apt-get install -y curl\
                                         gnupg2\
                                         software-properties-common\
                                         postgresql-${POSTGRES_VERSION}\
                                         postgresql-client-${POSTGRES_VERSION}\
                                         postgresql-contrib-${POSTGRES_VERSION}

RUN ls /usr/lib/postgresql/${POSTGRES_VERSION}/bin/postgres

RUN curl https://www.postgresql.org/media/keys/ACCC4CF8.asc | apt-key add -

RUN echo "deb http://apt.postgresql.org/pub/repos/apt/ precise-pgdg main" > /etc/apt/sources.list.d/pgdg.list

USER postgres

RUN /etc/init.d/postgresql start &&\
    psql -U postgres --command "ALTER USER postgres WITH PASSWORD '${POSTGRES_PASSWORD}';"
    # psql --command "CREATE USER ${PGUSER} WITH SUPERUSER PASSWORD '${PGPASSWORD}';" &&\
    # createdb -O ${PGUSER} ${PGUSER} #'${PGPASSWORD}'

RUN echo "host all  all    0.0.0.0/0  md5" >> /etc/postgresql/${POSTGRES_VERSION}/main/pg_hba.conf

RUN echo "listen_addresses='*'" >> /etc/postgresql/${POSTGRES_VERSION}/main/postgresql.conf

# EXPOSE 5432

VOLUME  ["/etc/postgresql", "/var/log/postgresql", "/var/lib/postgresql"]

CMD /usr/lib/postgresql/$POSTGRES_VERSION/bin/postgres -D /var/lib/postgresql/${POSTGRES_VERSION}/main -c config_file=/etc/postgresql/${POSTGRES_VERSION}/main/postgresql.conf